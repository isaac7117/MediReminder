// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  email         String        @unique
  password      String
  fullName      String
  dateOfBirth   DateTime?
  phoneNumber   String?
  profileImage  String?
  pushSubscriptions String[] // JSON array of push subscriptions
  timezone      String        @default("America/Mexico_City")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  medications   Medication[]
  reminders     Reminder[]
  ocrTrainingSamples OcrTrainingSample[]
}

model Medication {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  userId                String    @db.ObjectId
  name                  String
  dosage                String
  frequencyType         String    // 'hourly', 'daily', 'weekly', 'custom'
  frequencyValue        Int
  frequencyTimes        String[]  // JSON array of times (HH:mm format)
  frequencyDays         Int[]     // Days of week (0-6)
  startDate             DateTime
  endDate               DateTime?
  isContinuous          Boolean   @default(false)
  instructions          String?
  imageUrl              String?
  prescriptionImageUrl  String?
  active                Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders             Reminder[]

  @@index([userId])
}

model Reminder {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  medicationId    String    @db.ObjectId
  userId          String    @db.ObjectId
  scheduledTime   DateTime
  status          String    @default("pending") // 'pending', 'taken', 'missed', 'skipped'
  takenAt         DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  medication      Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([medicationId])
  @@index([scheduledTime])
  @@index([status])
}

model OcrTrainingSample {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String?  @db.ObjectId
  user             User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  source           String
  ocrText          String
  modelOutput      Json?
  correctedOutput  Json
  consent          Boolean  @default(false)
  includeInTraining Boolean @default(false)
  language         String?
  imageHash        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([consent, includeInTraining])
}

model OcrScanMetric {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String?  @db.ObjectId
  modelUsed       String
  confidence      String
  medicationCount Int
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([modelUsed])
  @@index([createdAt])
}

model OcrTrainingJob {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  status           String
  baseModel        String
  fineTunedModelId String?
  trainingFileId   String?
  fineTuneJobId    String?
  sampleCount      Int
  error            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  startedAt        DateTime?
  finishedAt       DateTime?
}
